<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ServerSide Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body { padding: 1.5rem; }
    main.layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 1rem; align-items: start; }
    .card { padding: 1rem; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); }
    .card h3 { margin-top: 0; }
    #logs { height: 280px; overflow-y: auto; background: #0b0b0b; color: #e0e0e0; padding: 0.75rem; border-radius: 8px; font-family: monospace; font-size: 0.95rem; }
    #properties { height: 220px; }
    code { white-space: pre-wrap; }
    small { display: block; margin-top: 0.3rem; }
    .status-chip { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.2rem 0.6rem; border-radius: 999px; background: #f3f4f6; }
    .status-on { background: #e0f5e9; color: #0c6b34; }
    .status-off { background: #fff3e0; color: #9c4300; }
    .quick-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.5rem 1rem; }
    .full-width { grid-column: 1 / -1; }
    .status-banner { position: sticky; top: 0; z-index: 10; margin-bottom: 1rem; padding: 0.8rem 1rem; border-radius: 8px; background: #f3f4f6; color: #111827; display: none; box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
    .status-banner.show { display: block; }
    .status-banner.error { background: #fdecea; color: #8a1c1c; }
    .delete-gap { margin-top: 0.75rem; }
    #status-text { margin: 0.25rem 0 0; }
    @media (max-width: 600px) {
      body { padding: 1rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ServerSide Control Panel</h1>
    <p>Manage Minecraft server profiles, run the API and controller, edit properties, and watch live logs.</p>
  </header>

  <div id="status-banner" role="status" aria-live="polite"></div>

  <main class="layout">
      <article class="card">
        <h3>Active & Controls</h3>
        <p><strong>Active profile:</strong> <span id="active-profile">None</span></p>
        <p>
          <span id="api-status" class="status-chip status-off">API: Stopped</span>
          <span id="controller-status" class="status-chip status-off">Controller: Stopped</span>
        </p>
        <div class="quick-grid">
          <button id="start-api-btn">Start API</button>
          <button id="start-controller-btn">Start Controller</button>
          <button id="stop-api-btn" class="secondary">Stop API</button>
          <button id="stop-controller-btn" class="secondary">Stop Controller</button>
        </div>
        <p id="status-text"></p>
      </article>

      <article class="card">
        <h3>Profiles</h3>
        <label for="profile-select">Select profile</label>
        <select id="profile-select"></select>
        <div class="quick-grid">
          <button id="activate-btn">Activate</button>
          <button id="bootstrap-btn" class="secondary">Create folders</button>
          <button id="load-form-btn" class="secondary">Load into form</button>
        </div>
        <div class="quick-grid delete-gap">
          <button id="delete-profile-btn" class="contrast">Delete profile</button>
        </div>
        <small id="profile-hint">Profiles load from <code>server_profiles.json</code> in the control panel folder.</small>
      </article>

      <article class="card">
        <h3>server.properties</h3>
        <div class="quick-grid">
          <button id="load-props-btn" class="secondary">Load from active</button>
          <button id="save-props-btn">Save changes</button>
        </div>
        <textarea id="properties" aria-label="server.properties"></textarea>
        <small>Each line should be <code>key=value</code>. Unknown keys are kept as-is.</small>
      </article>

      <article class="card">
        <h3>Create / Update Profile</h3>
        <form id="profile-form">
          <div class="form-grid">
            <label>Name<input type="text" name="name" required /></label>
            <label>Server folder<input type="text" name="server_path" placeholder="C:/MCServers/Vanilla" required /></label>
            <label class="full-width">Description<textarea name="description" rows="2" placeholder="Optional notes"></textarea></label>
            <label>Server IP<input type="text" name="server_ip" value="localhost" /></label>
            <label>Run script<input type="text" name="run_script" value="run.bat" /></label>
            <label>RCON password<input type="text" name="rcon_password" /></label>
            <label>RCON port<input type="number" name="rcon_port" value="27001" /></label>
            <label>Query port<input type="number" name="query_port" value="27002" /></label>
            <label>Auth key<input type="text" name="auth_key" /></label>
            <label>Shutdown key<input type="text" name="shutdown_key" /></label>
            <label>Inactivity limit (seconds)<input type="number" name="inactivity_limit" value="1800" /></label>
            <label>Polling interval (seconds)<input type="number" name="polling_interval" value="60" /></label>
            <label class="full-width">
              <input type="checkbox" name="pc_sleep_after_inactivity" checked />
              Sleep PC when inactive
            </label>
            <div class="full-width">
              <button type="submit">Save / Update profile</button>
            </div>
          </div>
        </form>
      </article>

      <article class="card full-width">
        <h3>Live Logs</h3>
        <p>Listening to the latest controller log for the active profile.</p>
        <div id="logs"></div>
      </article>
  </main>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-Xf/yKobgrqY+lLd3y+SZV6dLDQOzoJwgkC+XZT3IT1+G37nQVwJsrMdGg4BJd5G0" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
  <script src="{{ url_for('static', filename='control_panel.js') }}"></script>
</body>
</html>
